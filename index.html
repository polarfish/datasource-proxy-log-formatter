<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Datasource Proxy log formatter service</title>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.2.3/gh-fork-ribbon.min.css"/>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/css2?family=Ubuntu+Mono:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/default.min.css">
  <style>
    body {
      font-family: 'Ubuntu Mono', monospace;
      font-size: 14px;
    }
  </style>
</head>
<body>
<a class="github-fork-ribbon" href="https://github.com/polarfish/datasource-proxy-log-formatter"
   data-ribbon="Fork me on GitHub"
   title="Fork me on GitHub">Fork me on GitHub</a>
<div class="container-fluid d-flex flex-column vh-100 overflow-hidden">
  <div class="flex-shrink-0">
    <h1>Datasource Proxy log formatter service</h1>
  </div>

  <div class="row flex-grow-1 overflow-hidden">
    <div class="col-4 mh-100 overflow-auto py-2">
      <button type="button" id="formatLog" class="btn btn-danger">Format Log</button>
      <button type="button" id="loadDemoLog" class="btn btn-info">Demo Log</button>
      <br/>
      <br/>
      <textarea class="form-control h-75" id="logEntries"
                spellcheck="false"
                placeholder="Paste one or more SLF4JQueryLoggingListener json log entries"></textarea>
    </div>
    <div class='col mh-100 overflow-auto'>
      <div class='row flex-grow-1'>
        <div class="col mh-100 overflow-auto py-2" id="sql" style="font-size: 14px;">

        </div>
      </div>
    </div>
  </div>
</div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js"></script>
<script src="https://unpkg.com/sql-formatter@latest/dist/sql-formatter.min.js"></script>
<script>
  let formatLogButton = document.getElementById("formatLog");
  let loadDemoLog = document.getElementById("loadDemoLog");
  let logEntriesTextarea = document.getElementById("logEntries");
  let sqlCodeBlock = document.getElementById("sql");

  formatLogButton.addEventListener("click", function (e) {

    let formattedLogInnerHtml = "";
    logEntriesTextarea.value.split("\n").forEach(line => {

      if (!line.includes("SLF4JQueryLoggingListener")) {
        return;
      }

      let match = line.match("([{]{1}.*[}]{1})");
      if (!match) {
        alert("Bad input");
        return;
      }

      let logEntriesJson = JSON.parse(match[0]);

      while (logEntriesJson.params[0] && logEntriesJson.params[0].length > 0) {
        let param = logEntriesJson.params[0].shift();
        // console.log("Interpolating query with " + param);
        logEntriesJson.query[0] = logEntriesJson.query[0].replace(
            "?",
            param !== "" && Number.isInteger(Number(param))
                ? param
                : "'" + param + "'");
      }

      let formattedSql = sqlFormatter.format(logEntriesJson.query[0], {
        language: "sql",
        uppercase: true
      });
      formattedLogInnerHtml += `<code class="language-sql">
-- connection: ${logEntriesJson.connection}
-- time: ${logEntriesJson.time}
-- success: ${logEntriesJson.success}
-- type: ${logEntriesJson.type}
-- batch: ${logEntriesJson.batch}
-- batchSize: ${logEntriesJson.batchSize}
-- querySize: ${logEntriesJson.querySize}
${formattedSql}
</code>
`;

    });

    sqlCodeBlock.innerHTML = "<pre>" + formattedLogInnerHtml + "</pre>";
    hljs.highlightAll();
  });

  loadDemoLog.addEventListener('click', function () {
    logEntriesTextarea.value =
        `2021-10-14 15:29:52.409 DEBUG [customer-service,,,] 90994 --- [           main] n.t.d.l.l.SLF4JQueryLoggingListener      : {"name":"dataSource-proxy", "connection":121, "time":2, "success":true, "type":"Prepared", "batch":false, "querySize":1, "batchSize":0, "query":["SELECT * FROM customers customers0_ WHERE customers0_.id = ?"], "params":[["e98a53a5-9ca2-4c8b-8ecd-9bcb076e02c0"]]}
2021-10-14 15:29:53.662 DEBUG [customer-service,,,] 86163 --- [           main] n.t.d.l.l.SLF4JQueryLoggingListener      : {"name":"dataSource-proxy", "connection":122, "time":17, "success":true, "type":"Prepared", "batch":false, "querySize":1, "batchSize":0, "query":["select * from customers customers0_ where (customers0_.department=? and (customers0_.relation_id=? or customers0_.relation_id=?) and (customers0_.stream is null or customers0_.stream=? or (customers0_.relation_id=? or customers0_.relation_id=? or customers0_.relation_id=?) and (customers0_.stream=?)) or customers0_.department=? and (customers0_.relation_id=? or customers0_.relation_id=? or customers0_.relation_id=? or customers0_.relation_id=?) and (customers0_.stream is null or customers0_.stream=? or (customers0_.relation_id=? or customers0_.relation_id=? or customers0_.relation_id=?) and (customers0_.stream=?)) or customers0_.department=? and (customers0_.relation_id=? or customers0_.relation_id=? or customers0_.relation_id=? or customers0_.relation_id=? or customers0_.relation_id=? or customers0_.relation_id=? or customers0_.relation_id=? or customers0_.relation_id=? or customers0_.relation_id=?) and (customers0_.stream is null or customers0_.stream=? or (customers0_.relation_id=? or customers0_.relation_id=? or customers0_.relation_id=?) and (customers0_.stream=?)) or customers0_.department=? and (customers0_.relation_id=? or customers0_.relation_id=? or customers0_.relation_id=?) and (customers0_.stream is null or customers0_.stream=? or (customers0_.relation_id=? or customers0_.relation_id=? or customers0_.relation_id=?) and (customers0_.stream=?))) and (customers0_.status=? or customers0_.status=? or customers0_.status=? or customers0_.status=? or customers0_.status=? or customers0_.status=? or customers0_.status=? or customers0_.status=?) order by customers0_.start_date desc, customers0_.created_at desc limit ?"], "params":[["RnD","7c1e621fef6f4756bed27a53e97922b3","381e431f1e2346dda92f13115b4149de","","7c1e621fef6f4756bed27a53e97922b3","d60df6614cc946e594fd084e20ace081","8b1e622fef7f4756ded27a53e98922a4","Neo","Sales","8w32f6618bc946e594fd084e20ace081","8b1e622fef7f4756ded27a53e98922a4","d60df6614cc946e594fd084e20ace081","c4rtf6614cc946e594fd084e20ace081","","7c1e621fef6f4756bed27a53e97922b3","d60df6614cc946e594fd084e20ace081","8b1e622fef7f4756ded27a53e98922a4","Neo","Logistics","980df6618bc946e594fd084e20ace081","800df6618bc946e594fd084e20ace081","8w32f6618bc946e594fd084e20ace081","8w32f6618bc946e594fd084e20ace092","8b1e622fef7f4756ded27a53e98922a4","d60df6614cc946e594fd084e20ace081","c4rtf6614cc946e594fd084e20ace081","u4rtf6er4cc946e594fd084e20ace081","8b1e622fef7f4756ded27a53e98922b5","","7c1e621fef6f4756bed27a53e97922b3","d60df6614cc946e594fd084e20ace081","8b1e622fef7f4756ded27a53e98922a4","Neo","Marketing","980df6618bc946e594fd084e20ace081","8b1e622fef7f4756ded27a53e98922a4","d60df6614cc946e594fd084e20ace081","","7c1e621fef6f4756bed27a53e97922b3","d60df6614cc946e594fd084e20ace081","8b1e622fef7f4756ded27a53e98922a4","Neo","ENTERED","WAITING_ONBOARDING","ONBOARDED","READY","ACKNOWLEDGED","ACTIVE","ACTIVE_LOYAL","ACTIVE_VIP","10"]]}`;
  });

</script>
</html>
